import alerts from"./Alerts.js";import coll from"./CollectionHTML.js";import sb from"./StringBox.js";const EMPTY=[],fnEmpty=()=>EMPTY,fnParam=e=>e;window.loadItems=globalThis.void;export default function(a,n){if(a){(n=n||{}).delay=n.delay||400,n.minLength=n.minLength||3,n.maxLength=n.maxLength||16,n.maxResults=n.maxResults||10,n.optionClass=n.optionClass||"option",n.activeClass=n.activeClass||"active",n.blockSelector=n.blockSelector||".autocomplete",n.resultsSelector=n.resultsSelector||".results",n.source=n.source||fnEmpty,n.render=n.render||fnParam,n.select=n.select||fnParam,n.onReset=n.onReset||globalThis.void;const u=this;const d=a.closest(n.blockSelector).querySelector(n.resultsSelector),m=a.nextElementSibling;a.type="search",a.setAttribute("autocomplete","off");let s,l,o=EMPTY,i=-1;this.getData=()=>o,this.getIndex=()=>i,this.getItem=e=>o[e??i],this.getCurrentItem=()=>o[i],this.getCurrentOption=()=>d.children[i],this.getCode=e=>sb.getCode(a.value,e),this.isset=()=>a,this.isItem=()=>-1<i,this.isLoaded=()=>m.value,this.getInputValue=()=>m,this.getAutocomplete=()=>a,this.setValue=(e,t)=>(e?(m.value=e,a.value=t):m.value=a.value="",u);const h=e=>0<=e&&e<coll.size(d.children),v=()=>{d.innerHTML="",d.classList.remove(n.activeClass)},g=()=>(i=-1,m.value="",v(),u);function t(e){i=h(e)?e:i,d.children.forEach((e,t)=>e.classList.toggle(n.activeClass,t==i))}function r(e,t){e&&h(t)&&(i=t,u.setValue(n.select(o[t],u),e.innerText),v())}function c(){s=!0,alerts.loading(),window.loadItems=(e,t,s)=>{window.loadItems=globalThis.void,u.render(coll.parse(s?.data))},n.source(a.value,u),s=!1}this.reset=()=>(m.value&&n.onReset(u),g()),this.reload=()=>(a.value="",a.focus(),u.reset()),this.render=e=>(g(),(o=e||EMPTY).slice(0,n.maxResults).forEach((e,t)=>{e=sb.wrap(n.render(e,t,o),a.value);d.innerHTML+=`<li class="${n.optionClass}">${e}</li>`}),d.children.forEach((t,s)=>{t.addEventListener("click",e=>r(t,s))}),d.classList.add(n.activeClass),alerts.working(),u),a.onkeydown=e=>{return 38==e.keyCode?t(i-1):40==e.keyCode?t(i+1):9==e.keyCode?r(u.getCurrentOption(),i):void(13==e.keyCode&&(e.preventDefault(),r(u.getCurrentOption(),i)))},a.oninput=e=>{var t=coll.size(a.value);if(t<n.minLength)return u.reset();t<n.maxLength&&!s&&(clearTimeout(l),l=setTimeout(c,n.delay))},a.onchange=e=>{a.value?setTimeout(()=>{m.value||n.onReset(u)},270):u.reset()},a.onblur=e=>{setTimeout(v,280)}}}