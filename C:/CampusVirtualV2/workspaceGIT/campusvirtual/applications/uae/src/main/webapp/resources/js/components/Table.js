import coll from"./CollectionHTML.js";import i18n from"../i18n/langs.js";const EMPTY=[],fnTrue=()=>!0;export default function(s,n){(n=n||{}).sortClass=n.sortClass||"sort",n.sortAscClass=n.sortAscClass||"sort-asc",n.sortDescClass=n.sortDescClass||"sort-desc",n.sortNoneClass=n.sortNoneClass||"sort-none",n.activeClass=n.activeClass||"active",n.rowActionClass=n.rowActionClass||"row-action",n.tableActionClass=n.tableActionClass||"table-action",n.msgConfirmRemove=n.msgConfirmRemove||"remove",n.msgConfirmReset=n.msgConfirmReset||"removeAll",n.rowEmptyTable=n.rowEmptyTable||'<tr><td class="no-data" colspan="99">'+i18n.get(n.msgEmptyTable)+"</td></tr>",n.beforeRender=n.beforeRender||globalThis.void,n.onHeader=n.onHeader||(()=>s.tHead.innerHTML),n.onRender=n.onRender||globalThis.void,n.onFooter=n.onFooter||(()=>s.tFoot.innerHTML),n.afterRender=n.afterRender||globalThis.void,n.onRemove=n.onRemove||fnTrue,n.onReset=n.onReset||fnTrue;const t=this,o={},r=s.tBodies[0];let a=EMPTY,i=-1;function l(e,s,t){i18n.confirm(s.dataset.confirm)&&(i=t,n[e](a[t],s,t))}function c(e){return i=-1,a=e||[],o.size=a.length,r.classList.remove(n.activeClass),n.beforeRender(o),s.tHead.innerHTML=n.onHeader(o),o.columns=coll.size(s.tHead.rows[0]?.cells),r.innerHTML=o.size?coll.render(a,n.onRender,o):n.rowEmptyTable,s.tFoot.innerHTML=n.onFooter(o),n.afterRender(o),r.classList.add(n.activeClass),r.rows.forEach((e,t)=>{e.onchange=e=>{i=t,(n[e.target.name+"Change"]||globalThis.void)(a[t],e.target,t)},e.getElementsByClassName(n.rowActionClass).setClick((e,s)=>{l(s.getAttribute("href"),s,t),e.preventDefault()})}),t}this.clear=()=>(i=-1,t),this.set=(e,s)=>(n[e]=s,t),this.getData=()=>a,this.getIndex=()=>i,this.getResume=()=>o,this.getItem=e=>a[e??i],this.isItem=()=>-1<i&&i<a.length,this.getCurrentItem=()=>a[i],this.getLastItem=()=>a.at(-1),this.getCurrentRow=()=>r.children[i],this.isEmpty=()=>!a.length,this.size=()=>a.length,this.getTable=()=>s,this.querySelector=e=>s.querySelector(e),this.querySelectorAll=e=>s.querySelectorAll(e),this.html=e=>s.querySelector(e).innerHTML,s.tFoot.onchange=e=>{e=e.target;(n[e.name+"Change"]||globalThis.void)(e,t)},this.render=c,this.push=e=>(a.push(e),c(a)),this.add=e=>(delete e.id,t.push(e)),this.insert=(e,s)=>(e.id=s,t.push(e)),this.update=e=>(Object.assign(a[i],e),c(a)),this.save=(e,s)=>s?n.insert(e,s):n.update(e),t.set("#remove",(e,s)=>{(s.dataset.confirm||i18n.confirm(n.msgConfirmRemove))&&n.onRemove(e)&&(a.splice(i,1),c(a))}),t.set("#reset",(e,s)=>{(s.dataset.confirm||i18n.confirm(n.msgConfirmReset))&&n.onReset(t)&&c(EMPTY)});const m=s.tHead.getElementsByClassName(n.sortClass);m.setClick((e,s)=>{var t=s.classList.contains(n.sortAscClass)?n.sortDescClass:n.sortAscClass;const o=s.getAttribute("href").substring(1);m.forEach(e=>{e.classList.remove(n.sortAscClass,n.sortDescClass),e.classList.add(n.sortNoneClass)}),s.classList.remove(n.sortNoneClass),s.classList.add(t);const r=n["sort-"+o]||((e,s)=>e[o]<s[o]?-1:e[o]>s[o]?1:0);s=t==n.sortDescClass?(e,s)=>r(s,e):r;c(a.sort(s))}),this.setActions=e=>{const o=e=>e<0?0:Math.min(e,a.length-1);return e.getElementsByClassName(n.tableActionClass).setClick((e,s)=>{var t=s.getAttribute("href");l(t,s,"#first"==t?o(0):"#prev"==t?o(i-1):"#next"==t?o(i+1):"#last"==t?o(a.length):i),e.preventDefault()}),t}}