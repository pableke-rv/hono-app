import api from"./Api.js";import alerts from"./Alerts.js";import Table from"./Table.js";import Datalist from"./Datalist.js";import Autocomplete from"./Autocomplete.js";import i18n from"../i18n/langs.js";const divNull=document.createElement("div");export default function(a,l){a=isstr(a)?document.forms.findOne(a):a,(l=l||{}).defaultMsgOk=l.defaultMsgOk||"saveOk",l.defaultMsgError=l.defaultMsgError||"errForm",l.dateClass=l.dateClass||"ui-date",l.boolClass=l.boolClass||"ui-bool",l.checkAllClass=l.checkAllClass||"ui-check-all",l.floatFormatClass=l.floatFormatClass||"ui-float",l.integerFormatClass=l.integerFormatClass||"ui-integer",l.numberFormatClass=l.numberFormatClass||"ui-number",l.inputErrorClass=l.inputErrorClass||"ui-error",l.tipErrorClass=l.tipErrorClass||"ui-errtip",l.groupSelector=l.groupSelector||"label",l.negativeNumClass=l.negativeNumClass||"text-red";const o=this,s="",e="input:not([type=hidden]),select,textarea",r=(this.isset=()=>a,this.getId=()=>a.id.value,this.focus=e=>(e&&e.focus(),o),this.setFocus=e=>o.focus(o.getInput(e)),this.autofocus=()=>o.focus(a.elements.find(e=>e.isVisible("[tabindex]:not([type=hidden],[readonly],[disabled])"))),this.getInput=e=>a.elements.findOne(e),this.getInputs=e=>a.elements.query(e),this.querySelector=e=>a.querySelector(e),this.querySelectorAll=e=>a.querySelectorAll(e),this.setCache=e=>(a.dataset.cache=e,o),this.isCached=e=>e==a.id.value||e==a.dataset.cache,this.resetCache=()=>(delete a.dataset.cache,o.setval("#id")),this.loading=()=>(alerts.loading(),o),this.showOk=e=>(alerts.showOk(e),o),this.showInfo=e=>(alerts.showInfo(e),o),this.showWarn=e=>(alerts.showWarn(e),o),this.showError=e=>(alerts.showError(e),o),this.showAlerts=e=>(alerts.showAlerts(e),o),(e,t)=>e.classList.contains(t)),i=(e,t)=>(e.forEach(t),o),n=(t,s)=>(t=t||e,i(a.elements,e=>e.matches(t)&&s(e))),u=(this.html=e=>a.querySelector(e).innerHTML,this.text=(e,t)=>(a.querySelectorAll(e).text(t),o),this.render=(e,t)=>(a.querySelectorAll(e).render(t),o),this.hide=e=>(a.querySelectorAll(e).hide(),o),this.show=e=>(a.querySelectorAll(e).show(),o),this.setVisible=(e,t)=>t?o.show(e):o.hide(e),this.disabled=(t,e)=>n(e,e=>e.setDisabled(t)),this.readonly=(t,e)=>n(e,e=>e.setReadonly(t)),this.eachInput=(e,t)=>n(e,t),(e,t)=>{e.value=t||s,e.classList.toggle(l.negativeNumClass,e.value.startsWith("-"))});function h(e,t){return"SELECT"!=e.tagName||t?e.value=t||s:e.selectedIndex=0,o}function c(e,t){return"date"==e.type?e.value=t?t.substring(0,10):s:r(e,l.floatFormatClass)?u(e,i18n.isoFloat(t)):r(e,l.integerFormatClass)?u(e,i18n.isoInt(t)):r(e,l.boolClass)?e.value=i18n.boolval(t):"checkbox"===e.type?e.checked=t&&t.includes(e.value):"radio"===e.type?e.checked=e.value==t:h(e,t),p(e)}function d(e){return r(e,l.floatFormatClass)?i18n.toFloat(e.value):r(e,l.integerFormatClass)?i18n.toInt(e.value):r(e,l.numberFormatClass)?e.value?+e.value:null:e.value&&e.value.trim()}this.setValue=(e,t)=>e?c(e,t):o,this.setval=(e,t)=>o.setValue(o.getInput(e),t),this.values=(e,t)=>n(e,e=>c(e,t)),this.setData=(t,e)=>n(e,e=>c(e,t[e.name])),this.setAttribute=(e,t,s)=>(e&&e.setAttribute(t,s),o),this.setAttr=(e,t,s)=>o.setAttribute(o.getInput(e),t,s),this.getValue=e=>e&&d(e),this.getval=e=>o.getInput(e).value,this.valueOf=e=>o.getValue(o.getInput(e)),this.getData=e=>{const t={};return n(e,e=>{e.name&&("checkbox"===e.type&&e.checked?(t[e.name]=t[e.name]||[],t[e.name].push(e.value)):t[e.name]=d(e))}),t},this.copy=(e,t)=>h(o.getInput(e),o.getval(t)),this.reset=e=>n(e,e=>h(e)),this.restart=e=>{e=o.getInput(e);return e.focus(),h(e)},this.setTable=(e,t)=>new Table(a.querySelector(e),t),this.stringify=(e,t)=>o.setval(e,JSON.stringify(t)),this.saveTable=(e,t)=>o.stringify(e,t.getData()),this.setDatalist=(e,t)=>new Datalist(a.querySelector(e),t),this.setAutocomplete=(e,t)=>new Autocomplete(o.getInput(e),t),this.setAcItems=(e,t,s,r)=>(s=s||globalThis.void,o.setAutocomplete(e,{minLength:4,source:t,render:e=>e.label,select:e=>(s(e),e.value),onReset:r})),this.setDateRange=(t,s)=>(t=isstr(t)?o.getInput(t):t,s=isstr(s)?o.getInput(s):s,t.addEventListener("blur",e=>s.setAttribute("min",t.value)),m(s,"blur",e=>t.setAttribute("max",s.value))),this.getOptionText=function(e){e=o.getInput(e);return e.options[e.selectedIndex]?.innerHTML};const m=(e,t,s)=>(e.addEventListener(t,s),o),g=(this.change=e=>m(a,"change",e),this.submit=e=>m(a,"submit",e),this.beforeReset=e=>m(a,"reset",e),this.afterReset=t=>m(a,"reset",e=>setTimeout(()=>t(e),1)),this.setClick=(e,t)=>{return e=e,s=e=>e.setClick(t),i(a.querySelectorAll(e),s);var s},this.click=e=>(a.querySelector(e).click(),o),this.onChange=(e,t)=>e?m(e,"change",t):o,this.onChangeInput=(e,t)=>o.onChange(o.getInput(e),t),this.onChangeFile=(e,t)=>{let s,r=0;const a=new FileReader,l=o.getInput(e),i=e=>{(s=l.files[e])&&a.readAsArrayBuffer(s)};return a.onload=e=>{t(l,s,a.result,r),i(++r)},m(l,"change",()=>i(r))},this.setField=(e,t,s)=>{e=o.getInput(e);return e?(m(e,"change",s),c(e,t)):o},(e,t)=>{return(e.closest(l.groupSelector)||divNull).getElementsByClassName(l.tipErrorClass).text(t),o}),p=e=>(e.classList.remove(l.inputErrorClass),g(e,s)),v=(e,t)=>(e.focus(),e.classList.add(l.inputErrorClass),g(e,i18n.get(t)));this.closeAlerts=()=>(alerts.closeAlerts(),i(a.elements,p)),this.setOk=e=>(alerts.showOk(e||l.defaultMsgOk),i(a.elements,p)),this.setError=(e,t,s)=>(e=isstr(e)?o.getInput(e):e,v(e,s),o.showError(t)),this.setErrors=(s,r)=>{if(isstr(s))return o.showError(s);r=r||e;return a.elements.eachPrev(e=>{return e.isVisible(r)&&((t=s[(e=e).name])?v(e,t):p(e));var t}),o.showError(s.msgError||l.defaultMsgError)},this.isValid=(e,t)=>{var s=o.closeAlerts().getData(t),e=e(s,i18n.getValidators());return e.isOk()?s:!o.setErrors(e.getMsgs(),t)},this.send=async e=>{var t=new FormData(a),t="multipart/form-data"==a.enctype?t:new URLSearchParams(t);return api.init().setMethod(a.method).setBody(t).send(e||a.action).catch(e=>{throw o.setErrors(e),e})},a&&(a.elements.forEach(s=>r(s,l.floatFormatClass)?(s.addEventListener("change",e=>u(s,i18n.fmtFloat(s.value))),u(s,s.value&&i18n.isoFloat(+s.value))):r(s,l.integerFormatClass)?(s.addEventListener("change",e=>u(s,i18n.fmtInt(s.value))),u(s,s.value&&i18n.isoInt(+s.value))):void(r(s,l.boolClass)?s.value=i18n.boolval(s.value):r(s,l.dateClass)?s.type="date":r(s,l.checkAllClass)&&s.addEventListener("click",e=>{a.elements.forEach(e=>{var t;"checkbox"==(t=e).type&&t.name==s.id&&(e.checked=s.checked)})}))),a.setAttribute("novalidate","1"),o.autofocus().beforeReset(e=>o.closeAlerts().autofocus()))}