import Form from"../../components/Form.js";import tabs from"../../components/Tabs.js";import pf from"../../components/Primefaces.js";import i18n from"../../i18n/langs.js";import factura from"../../model/xeco/Factura.js";import uxxiec from"../../model/xeco/Solicitud.js";import solicitudes from"./xeco.js";import fiscal from"../../data/fiscal.js";document.addEventListener("DOMContentLoaded",()=>{const t=factura.getLinea(),i=e=>{factura.setIva(e);var a=f.getResume(),e=a.imp*(e/100);o.text("#imp-iva",i18n.isoFloat(e)+" €").text("#imp-total",i18n.isoFloat(a.imp+e)+" €")},s=e=>{factura.setSujeto(e),o.setVisible(".grupo-exento",factura.isExento())},a=a=>{factura.setSubtipo(a);a=l.getCurrentItem();if(a){let e="cp";factura.isFactura()&&(e="c"+a.imp,e+=256&a.int?"ep":"no",t=128&a.int||256&a.int,e+=t?2048&a.int?"es":"np":2&a.int?"ue":"zz");var t=fiscal[e+factura.getSubtipo()]||fiscal.default;o.setData(t,".ui-fiscal").setval("#nifTercero",l.getCode()).setVisible("#ac-recibo",factura.isRecibo()).setVisible(".firma-gaca",factura.isFirmaGaca()),s(t.sujeto),i(t.iva)}},r=e=>{factura.setFace(e),o.text(".grupo-gestor > .label",factura.isPlataforma()?"Nombre de la plataforma:":"Órgano Gestor:").setVisible(".grupo-face",factura.isFace()).setVisible(".grupo-gestor",factura.isFace()||factura.isPlataforma())},o=new Form("#xeco-fact"),c=(solicitudes(factura,o),pf.datalist(o,"#delegacion","#idDelegacion",{emptyOption:"Seleccione una delegación"})),l=o.setAutocomplete("#acTercero",{delay:500,minLength:5,source:e=>pf.sendTerm("rcFindTercero",e),render:e=>e.label,select:e=>(a(factura.getSubtipo()),pf.sendId("rcDelegaciones",e.value),e.value),onReset:c.reset}),n=o.setAcItems("#acOrganica",e=>pf.sendTerm("rcFindOrganica",e)),u=o.setAcItems("#acRecibo",e=>pf.sendTerm("rcFindRecibo",e)),f=(o.onChangeInput("#subtipo",e=>a(+e.target.value)).onChangeInput("#sujeto",e=>s(+e.target.value)).onChangeInput("#face",e=>r(+e.target.value)),o.setTable("#lineas-fact",{msgEmptyTable:"No existen conceptos asociados a la solicitud",beforeRender:e=>{e.imp=0,e.iva=factura.getIva()},onRender:t.row,onFooter:t.tfoot,afterRender:e=>{var a={onChange:i};pf.datalist(o,"#iva","#ivaPF",a).setLabels([0,4,10,21]).setValue(e.iva)}}));o.setClick("a#add-linea",e=>{var a=o.isValid(t.validate,".ui-linea");a&&(f.push(a),o.restart("#desc").setval("#imp").setval("#memo",f.getItem(0).desc)),e.preventDefault()}),window.loadDelegaciones=(e,a,t)=>{pf.showAlerts(e,a,t)&&c.setItems(JSON.read(t.delegaciones))},window.viewFactura=(e,a,t)=>{if(!pf.showAlerts(e,a,t))return!1;e=JSON.read(t.fact);factura.setData(e),o.setData(e).setval("#nifTercero",e.nif).readonly(factura.isDisabled()).setVisible(".insert-only",factura.isEditable()).setVisible(".update-only",factura.isDisabled()).setVisible(".firmable-only",factura.isFirmable()).setVisible(".rechazable-only",factura.isRechazable()).setVisible(".show-recibo",factura.isRecibo()).setVisible(".show-factura",factura.isFactura()).setVisible(".show-cp",factura.isCartaPago()).setVisible(".show-factura-uae",uxxiec.isUae()&&factura.isFactura()).setVisible(".show-uae",uxxiec.isUae()).setVisible(".show-gestor",factura.isFace()||factura.isPlataforma()).setVisible(".show-face",factura.isFace()).setVisible(".firma-gaca",factura.isFirmaGaca()),c.setItems(JSON.read(t.delegaciones)),f.render(JSON.read(t.data)),o.readonly(!factura.isEditableUae(),".editable-uae"),l.setValue(e.idTer,e.nif+" - "+e.tercero),n.setValue(e.idOrg,e.org+" - "+e.descOrg),u.setValue(e.idRecibo,e.acRecibo),s(e.sujeto),r(e.face),tabs.render(".load-data",e).showTab(1)},window.fnSend=()=>(factura.setLineas(f),!!o.isValid(factura.validate)&&(o.saveTable("#lineas-json",f),i18n.confirm("msgSend")))});