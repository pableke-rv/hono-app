import Form from"../../../components/Form.js";import perfil from"./perfil.js";function IrseRutas(){const r=this;var t=37.62568269999999,e=-.9965839000000187;const s={desp:1,mask:1,lat1:t,lng1:e,pais1:"ES",lat2:t,lng2:e,pais2:"ES"},i={desp:10,mask:1,lat1:t,lng1:e,pais1:"ES",lat2:t,lng2:e,pais2:"ES"},a={desp:0,mask:4,lat:t,lng:e,pais:"ES",origen:"Cartagena, España",lat1:t,lng1:e,pais1:"ES",destino:"Cartagena, España",lat2:t,lng2:e,pais2:"ES"},o={sizeOut:0,sizeVp:0},d={remove:"msgDelRuta",f1:(t,e)=>i18n.fmtDate(e.dt1),h1:(t,e)=>sb.minTime(e.dt1),f2:(t,e)=>i18n.fmtDate(e.dt2),h2:(t,e)=>sb.minTime(e.dt2),principal:(t,e)=>1&e.mask?'<span class="text-warn icon"> <i class="fal fa-flag-checkered"></i></span>':"",km1:i18n.isoFloat,km2:i18n.isoFloat,totKm:i18n.isoFloat,impKm:(t,e)=>n(e),totKm:i18n.isoFloat,totKmCalc:i18n.isoFloat,desp:t=>{let e=i18n.arrval("tiposDesp",t);return 1==t&&(e+=" ("+IRSE.matricula+")"),e}};let l;function n(t){return i18n.isoFloat(t.km1*IRSE.gasolina)}function u(t){l.forEach(t=>{t.mask&=-2}),t.mask|=1}this.getImpKm=()=>o.impKm,this.getTotKm=()=>o.totKm,this.getTotKmCalc=()=>o.totKmCalc,this.getLoc=()=>perfil.isMun()?s:i,this.getCT=()=>a,this.getAll=()=>l,this.getResume=()=>o,this.getStyles=()=>d,this.size=()=>ab.size(l),this.empty=()=>ab.empty(l),this.first=()=>l[0],this.last=()=>ab.last(l),this.start=()=>r.size()&&sb.toDate(r.first().dt1),this.end=()=>r.size()&&sb.toDate(r.last().dt2),this.isSalidaTemprana=()=>r.size()&&sb.getHours(l[0].dt1)<14,this.isSalidaTardia=()=>r.size()&&21<sb.getHours(l[0].dt1),this.isLlegadaTemprana=()=>r.size()&&sb.getHours(r.last().dt2)<14,this.isLlegadaTardia=()=>r.size()&&sb.getHours(r.last().dt2)<5,this.isLlegadaCena=()=>r.size()&&21<sb.getHours(r.last().dt2),this.getNumRutasVp=()=>o.sizeVp,this.getNumRutasOut=()=>o.sizeOut,this.resume=function(){return o.totKm=o.totKmCalc=0,l.forEach(t=>{o.totKm+=nb.round(t.km1||0),o.totKmCalc+=nb.round(t.km2||0)}),o.km1=o.totKm,o.impKm=o.totKm*IRSE.gasolina,o.justifi=o.totKmCalc+.01<o.totKm,r},this.save=function(){return dom.setValue("#etapas",JSON.stringify(l)),r},this.valid=function(t){return dom.closeAlerts(),t.origen||dom.addError("#origen","errOrigen","errRequired"),1==t.desp&&dom.required("#matricula","errMatricula","errRequired"),sb.future(t.dt1)?!dom.addError("#f1","errFechaFutura"):t.dt1>t.dt2?!dom.addError("#f1","errFechasOrden"):dom.isOk()},this.validAll=function(){if(r.empty())return!dom.closeAlerts().addError("#origen","errItinerario");let e=l[0];if(!r.valid(e))return!1;for(let t=1;t<l.length;t++){var s=l[t];if(!r.valid(s))return!1;if(!e.pais2.startsWith(s.pais1.substring(0,2)))return!dom.addError("#destino","errItinerarioPaises");if(e.dt2>s.dt1)return!dom.addError("#destino","errItinerarioFechas");if(l[0].origen==s.origen)return!dom.addError("#destino","errMulticomision");e=s}return dom.isOk()},this.validItinerario=function(){if(r.paso1()&&r.validAll()){let e=0;return l.forEach(t=>{e+=1&t.mask}),1==e||!dom.addError("#destino","errMainRuta")}return!1},this.add=function(t,e){t.temp=!0,l.push(t),l.sort((t,e)=>sb.cmp(t.dt1,e.dt1));let s=0,i=l[0];for(let t=1;t<l.length;t++){var a=sb.diffDate(l[t].dt1,l[t-1].dt2);s<a&&(s=a,i=l[t-1])}return r.validAll()?(delete t.temp,u(i),t.km1=t.km2=e,IRSE.matricula=dom.getValue("#matricula"),dom.table("#rutas",l,o,d)):l.remove(t=>t.temp),r},this.paso1=()=>dom.closeAlerts().required("#objeto","errObjeto","errRequired").isOk()&&dom.loading(),this.paso1Col=()=>r.paso1()&&dom.past("#fAct","errDateLe","errRequired").gt0("#impAc","errGt0","errRequired").isOk(),this.paso2=()=>r.validItinerario()&&(1<r.size()||!dom.addError("#destino","errMinRutas"))&&dom.loading(),this.paso6=function(){return dom.closeAlerts(),o.justifi&&dom.required("#justifiKm","errJustifiKm","errRequired"),dom.isOk()&&dom.loading()},this.update=()=>(l=ab.parse(dom.getText("#rutas-data"))||[],o.out=l.filter(t=>1!=t.desp&&3!=t.desp&&!t.g),o.sizeOut=o.out.length,o.vp=l.filter(t=>1==t.desp),o.sizeVp=o.vp.length,dom.table("#rutas-out",o.out,o,d),r),this.init=e=>{if(r.update(),perfil.isAutA7j()||perfil.is1Dia()){const s=Object.assign({},r.getLoc(),l[0]);l[0]=s,r.resume(),e.change(t=>{r.resume().save()}).setField("#origen",s.origen,t=>{s.origen=s.destino=t.target.value}).setField("#desp",s.desp,t=>{s.desp=+t.target.value}).setField("#dist",s.km1,t=>{s.km1=s.km2=i18n.toFloat(t.target.value)}).setField("#f2",s.dt2,t=>{s.dt2=sb.endDay(t.target.value)}).setField("#f1",s.dt1,t=>{s.dt1=t.target.value,s.dt2=e.getInput("#f2")?s.dt2:sb.endDay(s.dt1)}),dom.toggleHide(".grupo-matricula",1!=s.desp)}else dom.onFindRow("#rutas",(t,e)=>{u(e.detail.data),dom.table("#rutas",l,o,d)}).onRenderTable("#rutas",t=>{var e=r.resume().last(l)||a;dom.setValue("#origen",e.destino).setValue("#f1",sb.enDate(e.dt2)).setValue("#h1",sb.minTime(e.dt2)).setValue("#destino","").copyVal("#f2","#f1").setValue("#h2","").setValue("#principal","0").setValue("#desp","").delAttrInput("#f1","max").delAttrInput("#f2","min").hide(".grupo-matricula"),e.dt1?1&e.mask?dom.setValue("#h1","").setFocus("#h1"):dom.setFocus("#destino"):dom.setFocus("#f1")}),dom.onChangeTable("#vp",t=>{var e=o.row,s=o.data;o.element.value=i18n.fmtFloat(o.element.value),s.km1=i18n.toFloat(o.element.value),r.resume(),dom.tfoot(t,o,d).toggleHide(".justifi-km",!o.justifi).setText(e.cells[9],n(s)+" €"),o.justifi&&dom.setFocus("#justifiKm"),r.save()});return dom.table("#rutas",l,o,d).onRenderTable("#rutas",r.save).table("#vp",o.vp,o,d).toggleHide(".justifi-km",!o.justifi).onChangeInput("#f1",t=>dom.setValue("#f2",t.value)).setRangeDate("#f1","#f2").onChangeInput("#desp",t=>dom.toggleHide(".grupo-matricula","1"!=t.value)).onChangeInput("#matricula",t=>{t.value=sb.toUpperWord(t.value)}),r}}export default new IrseRutas;